# Unity 动画系统 Mecanim

> 原创总结整理  
> 学习自 58开发网 && Unity圣典社区

有一个对 Mecanim 进行介绍的 **很好** 的一个视频 → <http://www.58kaifa.com/course/24>，在看完这个视频根据 Unity 圣典进行了下文整理时让我理解更加深刻，以后实践时会更加得心应手。

Unity 有一个丰富并且精密的动画系统叫做 Mecanim。

## 1. 相关术语整理 # #

Animation Clip 相关

- Animation Clip 动画剪辑：可以用于角色或者简单动画的动画数据。它是动作的简单“单元”，诸如（特别的实例）"Idle" 空闲、"Walk" 走路、"Run" 跑步、等等；
- Body Mask 身体蒙版：一个用于包括或排除身体部位骨骼的规格；[Asset (.mask)，在动画分层和导入器中使用]；
- Animation Curves 动画曲线：曲线可以附加到各种动画剪辑并且被游戏中的各种参数来控制；

Avatar 相关

- Avatar 阿凡达：从一个骨架重定向到另外一个骨架的界面；
- Retargeting 重定向：把为一个模型创建的动画应用到另外一个模型；[在外部工具中完成，比如 Max 或者 Maya]
- Skinning 蒙皮：把骨骼关节绑定到角色网格或者“皮肤”的过程；[在外部工具中完成，比如 Max 或者 Maya]
- Muscle Definition 肌肉定义：一个 Mecanim 概念，它允许你更直觉化地控制 Avatar。当一个 Avatar 准备好了之后，Mecanim 工作在肌肉空间，这比骨骼空间更直觉化；
- T-pose T 字姿势：角色双臂平身形成一个“T”字的姿势。角色必须保持这个姿势来制作 Avatar；
- Bind-pose 绑定姿势：角色在建模过程中的姿势；
- Human template 人形模板：一个预先定义的骨骼映射；[Asset (.ht)，用于从 FBX 文件中匹配骨骼到 Avatar]

Animator and Animator Controller 相关

- Animator Component 动画组件：在模型上使用 Mecanim 动画系统的组件。这个组件引用一个控制动画的 Animator Controller 资源；
- Root Motion 根动作：角色根级的动作，它可以被动画本身或者外部控制；
- Animator Controller (Asset) 动画控制器（资源）：动画控制器通过动画层中的动画状态机，还有被参数控制的混合树来控制动画。同一个 Animator Controller 可以被多个模型使用 Animator 组件引用；[Asset (.controller)]
- Animator Controller (Window) 动画控制器（窗口）：动画控制器在其中被可视化并编辑的窗口；
- Animation Layer 动画层：每个动画层包含一个控制整个模型或者部分模型的动画状态机。例如全身层可控制走路、跳跃并且更高的层面控制上半身动作比如投掷、跳跃。更高层对于身体部位有更高的控制权；
- Animation State Machine 动画状态机：一个控制动画状态之间交互的图。每个状态引用一个混合树或者单一动画剪辑；
- Animation Blend Tree 动画混合树：基于浮点动画参数，用于连续在多个近似的动画剪辑之间进行混合；
- Animation Parameters 动画参数：用于在脚本和 Animator Controller 之间通信。一些参数可以在脚本中设定并且在控制器中被引用，另外一些参数是基于在动画剪辑中的自定义曲线并且可以使用脚本 API 来采样；
- Inverse Kinematics (IK) 反向动力学：基于世界中各种对象来控制角色身体部分的能力；
- Animation Component 动画组件：使用非 Mecanim 动画时需要的组件；

## 2. Mecanim 提供的功能 # #

Mecanim 提供了：  

- 用于人类角色设计的简单工作流；
- 动画重定向 -- 能够把一个动画应用到多个不同模型的能力；
- 用于对齐影片剪辑的简化的工作流；
- 方便的影片剪辑预览，变换和交互。这使得动画师的工作可以更多地独立于程序员，方便在游戏逻辑代码挂接之前建立原型和预览；
- 使用一个可视化编程工具来管理动画之间复杂的交互；
- 对身体不同的地方使用不同的逻辑进行动画控制；

## 3. Mecanim 工作的流程 # #

Mecanim 的工作流可以被分割为如下 3 个主要的阶段：

1. 资源预备和导入。这是由美工或者动画师完成的工作，使用第三方的工具，比如 3D Max 或者 Maya。这一步独立于 Mecanim 的特性；
2. 为 Mecanim 设定角色，有 2 种途径：（1）类人角色配置。Mecanim 对于类人角色有一个特别的工作流，使用扩展后的 GUI 和重定向。配置包含创建和设定一个 Avatar 并且调整肌肉定义。（2）通用角色配置。这是为任何东西像是人、有动画的柱子、四足动物之类设计的。重定向在这里是不支持的，但是你仍然可以得到后文中描述的 Mecanim 的好处。
3. 让角色动起来。这包括设定动画剪辑和它们之间的交互，还包括状态机和混合树，列出动画参数，还有从代码中控制动画；

## 4. 资源准备和导入 # #

### 4.1. 类人网格 Humanoid meshes ## ##

为了应用 Mecanim 的类人动画系统和重定向的所有好处，你需要有一个绑骨并蒙皮的类人网格。

1. 一个角色模型通常是由 3D 包组成或者从一个导出前更加复杂的网格类型转换为多边形或者三角网格；
2. 一个定义了一组网格内的骨骼和他们的之间的运动关系的关节体系或者骨架，必须是为了控制角色的运动而创建的。众所周知创建这样关节体系的过程称作搭骨架（rigging）；
3. 一个网格或者皮肤必须被链接到关节体系来定义这个给定关节被动画化时角色的某一部分网格如随之运动。这个链接骨架和网格的过程就是蒙皮；

	![](http://www.ceeger.com/Manual/Images/AssetPreparationandImport-0.jpg)

PS 蒙皮网格 - 建模后，模型就会有纹理并且已三角化

总结：预备角色的步骤 →  

 **建模** -> **搭骨架** -> **蒙皮**  

#### Modelling 建模 ### ###

这是在 3D 建模工具包 - 3DSMax,Maya,Blender，诸如此类来建立你自己的类人网格的过程。尽管这是一个属于它们（建模工具）自己的主题，这里有一些你可以遵循的指导原则来保证一个模型可以很好的在 Unity 的动画系统中使用。

- 遵循合理的拓扑结构。一个“合理” 的网格结构的精确意义是非常微妙的，不过通常情况下，你应该牢记模型的顶点和三角面在动画化之后会怎样变形。一个不好的拓扑结构会让网格变形地非常难看。你可以从已有的 3D 角色网格学习很多拓扑结构是如何安排的以及这样安排的原因。
- 注意网格的缩放比例。做一次导入测试，比较导入的模型和一个“米立方”（大多情况下是一个边长 1 米的 Unity 标准立方体元素）。检测你的 3D 建模工具包使用的单位并且调整导出设定使得模型的尺寸处在相对这个立方体合适的比例。你必须小心，很容易创建出没有任何标注的缩放比例的模型并且最终会造成一些导入进 Unity 之后不成比例的物体。
- 安放角色使得角色的脚站在坐标原点或者模型的“锚点”。角色通常是竖直地走在地面上，如果角色的锚点（也就是他的变换中心）在地面上会更容易控制。
- 如果你会的话，使用 T 字姿态建模。这会对在三维空间中细化化多边形细节（比如，腋下）有帮助。这也会使得放置骨架到网格中更容易。
- 清理你的模型。只要可能的话，覆盖孔洞，焊接顶点并且移除隐藏的面，这会对蒙皮有帮助，特别是自动蒙皮过程。

#### Rigging 搭骨架 ### ###

这是创建骨架上的关节来控制你的模型进行运动的过程。3D 建模工具包提供了各种方法为类人骨架创建关节。从已经构建好的可以缩放后放入网格的两足动物骨架，到创建特别骨骼的工具还有父子化骨骼结构。尽管这方面的细节超出了 Unity 的范围，这里还是有一些通用的准则：

- 学习已有的类人骨架体系（比如，两足动物）并且在可能的地方尽量模仿这样的骨骼架构；
- 确保臀部是整个骨架的根节点；
- 在骨架中至少要有 15 个骨骼；
- 角色的关节点/骨骼结构应该按照自然的结构建立。手臂和腿成对出现，你应该对骨骼使用一致的命名（比如“arm_L”命名左臂”“arm_R”命名右臂，诸如此类）。一个体系结构可能包含：（1）HIPS - spine - chest - shoulders - arm - forearm - hand 即，臀部 - 脊椎 - 胸部 - 肩膀 - 手臂 - 前臂 - 手 （2）HIPS - spine - chest - neck - head 即，臀部 - 脊椎 - 胸部 - 脖子 - 头 （3）HIPS - UpLeg - Leg - foot - toe - toe_end 即，臀部 - 大腿 - 小腿 - 脚 - 脚趾 - 脚趾尖

#### Skinning 蒙皮 ### ###

这是给骨架附加网格的过程。蒙皮过程包括在你的网格中绑定顶点到骨骼，还有直接指定（硬绑定）或者混合多块骨骼的影响（软绑定）。不同的软件包使用不同的办法，比如，赋值给特别的顶点权重并且在网格上逐骨骼绘制影响到的顶点。最初的设定通常是自动化的，通过找最近的影响顶点或者使用“热度图”。蒙皮通常需要大量的工作并且使用动画测试来确保获得满意的皮肤变形效果。这个过程的一些指导准则如下：

- 最开始使用自动蒙皮过程来设定皮肤（查看 3DS Maya 之类的相关教程）；
- 为你的骨骼创建一个简单的动画或者导入一些动画数据作为一个蒙皮结果的测试。这给你一个快捷的办法来评估你的蒙皮是否在运动中看起来很好；
- 增量地编辑和细化你的蒙皮方案；
- 坚持在软绑定的时候每个顶点最多使用 4 个骨骼，这是 Unity 支持的数目上限。如果超过 4 个骨骼，那么在 Unity 播放骨骼动画时至少会有一些信息被丢失；

### 4.2. 导入动画 Importing Animations ## ##

### 4.3. 分割动画 Splitting Animations ## ##

一个动画化的角色典型地会在游戏中不同的情况有多个不同的动作。这些动作称为动画剪辑。比如，我们可能针对走路，跑步，跳跃，投掷，死亡之类有不同的动画剪辑。依赖于模型被动画化的方法，这些分离的动作可能作为不同的动画剪辑导入，或者当每个动作是简单的之前动作的延续时作为单个动画剪辑导入。在只有一个动画剪辑的情况下，这个剪辑必须用 Unity 分割成它的子组件剪辑，这会在你的工作流中引入一些其他步骤。

#### 使用含有预先分割的动画的模型工作 ### ###

使用起来最简单的模型类型是那些包含了预分割动画的。如果你有一个像那样的动画，你将会看到一列可以在播放窗口中（inspector右下角）点击播放来预览的的动画剪辑，如果需要，帧范围可以被修改。动画导入器的 Inspector 中动画标签页会看起来像这样：  
![](http://www.ceeger.com/Manual/Images/Splittinganimations-0.jpg)

#### 使用含有未分割动画的模型工作 ### ###

对于那些剪辑作为一个连续动画提供的模型，动画导入器 Inspector 中的动画标签页会看起来像这样：  
![](http://www.ceeger.com/Manual/Images/Splittinganimations-1.jpg)  

像这样4合1的情况，你可以定义符合分离动画序列（走，跳之类）的帧范围。你可以通过按下+创建一个新的动画剪辑并且选择包含动画的帧范围。例如，走路动画在帧 0-33；跑动画在帧 41-57；踢动画在帧 81-97；  
![](http://www.ceeger.com/Manual/Images/Splittinganimations-2.jpg)  

在导入设定中，分割动画表是你告诉 Unity 哪些在你资源文件中的帧构成一个动画剪辑的地方。你在这里指定的名字将会在你的游戏中用来激活它们。

#### PS：关于动画剪辑 Animation Clip ### ###

![](http://www.ceeger.com/Components/Images/class-AnimationClip-0.jpg)

在项目视图中选择一个导入的动画

动画剪辑存储着所有可使用于角色动画或简单动画的动画数据，它们只有一个属性而且不能修改：采样率。这是创建剪辑的采样率。请注意，导入动画时，Unity 运行关键帧减少，因此这不是帧的数量。

注：导入动画无法在动画视图中进行编辑，但如果你在 Unity 复制一个导入动画，复制的导入动画可以编辑。

#### 增加模型不包含的动画 ### ###

即使对那些没有肌肉定义的模型（也就是非 Mecanim），你也可以增加动画剪辑到动画组件中。你需要在动画属性中指定默认的动画剪辑，并且在 Animation 属性中指定可用的动画剪辑。你在这个非 Mecanim 模型中指定的动画也需要使用非 Mecanim 的方式（也就是说，肌肉定义属性应该被设置为 None）。

对于含有肌肉定义的模型（Mecanim），流程是不一样的：

1. 创建一个新的动画控制器；
2. 打开动画控制器窗口；
3. 拖放想要的动画剪辑到动画控制器窗口；
4. 拖放模型资源到层级视图；
5. 增加动画控制器资源到资源的动画组件；

#### 使用多个模型文件导入动画 ### ###

另外一种导入动画的方法是使用一个 Unity 允许的针对动画文件的命名方式。你创建不同的模型文件并且使用“模型名@动画名.fbx”的命名约定。比如，对一个叫“goober”的模型，你可以分别导入空闲，走路，跳跃和踢墙跳跃动画使用命名为“goober@idle.fbx”，“goober@walk.fbx”，“goober@jump.fbx”和“goober@walljump.fbx”的文件。这些文件中只有动画数据会被使用，即使原有文件是同网格数据一起导出的。  
![](http://www.ceeger.com/Manual/Images/Splittinganimations-3.jpg)  

Unity自动导入所有4个文件并且收集所有的动画到没有@标记的文件中。在上面的例子中，goober.mb文件将会自动建立到空闲，跳跃，走路和踢墙跳的引用。对于FBX文件，简单的导入一个没有动画的模型文件（也就是，goober.fbx）和4个命名为goober@动画名.fbx的剪辑，为每个文件导出想要的帧（在FBX对话框中选择）。

### 4.4. 如何获取类人模型 ## ##

这里有三种重要的途径来获取用于 Mecanim 动画系统的类人模型：

1. 使用一个程序化角色系统或者角色生成器诸如 Poser，Makehuman 或者 Mixamo。其中一些系统会为你的网格搭骨架和蒙皮（比如，Mixamo）但是另外一些不会。此外，这些方法可能需要你减少原有网格上的面数来适应 Unity；
2. 从 Unity Asset Store 购买演示示例和角色内容；
3. 可以从草图开始准备自己的角色；

### 4.5. 导出和验证 ## ##

Export & Verify

Unity 可以导入大量各式各样通用的本地 3D 文件格式。我们推荐的导出和验证你模型的格式是 FBX2012 因为这样可以：（1）导出带骨架层级的网格，法线，纹理和动画；（2）重新导入进你的 3D 包来更验证你的动画模型；（3）导出不带网格的动画；

End.

---

*见猎心喜 浅尝辄止 偶有所得 不足为法 & 温故而知新*

*纸上得来终觉浅 绝知此事要躬行 & 努力奋斗*
